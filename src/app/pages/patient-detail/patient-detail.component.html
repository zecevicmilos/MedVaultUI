<div class="card" *ngIf="info">
  <h3> {{info.firstName}} {{info.lastName}} <small class="badge">Broj medicinskog kartona:
      {{info.medicalRecordNumber}}</small> </h3> <small class="muted">Kreirano: {{info.createdAt |
    date:'short'}}</small>
    <div class="row" *ngIf="auth.role==='Admin'" style="gap:.5rem; margin-top:.5rem">
  <ng-container *ngIf="!isEditing">
    <button class="btn btn-blue-compact" (click)="startEdit()">Uredi</button>
    <button class="btn btn-ghost-danger" (click)="deletePatient()">Obriši pacijenta</button>
  </ng-container>

  <ng-container *ngIf="isEditing">
    <button class="btn pri btn-compact"
            (click)="savePatient()"
            [disabled]="!editFirstName.trim() || !editLastName.trim()">Sačuvaj izmene</button>
    <button class="btn" (click)="cancelEdit()">Otkaži</button>
  </ng-container>
</div>
  <div class="tabs mt">
    <div class="tab" [class.active]="tab==='ov'" (click)="tab='ov'">Osnovno</div>
    <div class="tab" [class.active]="tab==='id'" (click)="tab='id'">Lični dokumenti</div>
        <div class="tab" [class.active]="tab==='sc'" (click)="tab='sc'">Skenirani dokumenti</div>
    <div class="tab" [class.active]="tab==='ap'" (click)="tab='ap'">Pregledi</div>
  </div>
  <div *ngIf="tab==='ov'" class="grid" style="grid-template-columns:1fr 1fr">
    <div>
      <div class="label">Ime</div>
   
    <div class="input read-centered" style="background:#f8fafc" *ngIf="!isEditing">{{info.firstName}}</div>

    <!-- edit -->
    <input class="input" *ngIf="isEditing" [(ngModel)]="editFirstName" />
    </div>
  <!-- Prezime -->
  <div>
    <div class="label">Prezime</div>

    <div class="input read-centered" style="background:#f8fafc" *ngIf="!isEditing">{{info.lastName}}</div>

    <input class="input" *ngIf="isEditing" [(ngModel)]="editLastName" />
  </div>
    <div class="row" style="margin-bottom:.75rem">
      <div class="label" style="margin:0">Odeljenje</div>
      <div class="input read-centered" style="background:#f8fafc; max-width:320px;" *ngIf="!isEditing">
      {{ deptName || 'N/A' }}
    </div>
    
    </div>
  </div>
  <!-- Skenirani dokumenti -->
  <div *ngIf="tab==='sc'" class="mt">
    <div class="row"> <select class="input" [(ngModel)]="scanType" style="max-width:160px">
        <option>Rendgen</option>
        <option>Ultrazvuk</option>
        <option>CT</option>
        <option>Slika</option>
        <option>PDF</option>
      </select> 
      <div class="file-wrap">
  <input #scanInput id="scanInput" type="file"
         (change)="onScan($event)"
         accept="application/pdf,image/*"
         class="file-input" />
  <label for="scanInput" class="file-label">Izaberi fajl</label>
  <span class="file-name">{{ scanFile?.name || 'Nije izabran fajl' }}</span>
</div>

<button class="btn pri btn-compact" (click)="uploadScan(scanInput)">Sačuvaj</button>
    </div>
<table class="table mt" *ngIf="recs.length">
  <thead>
    <tr>
      <th>Tip</th>
      <th>Naziv</th>
      <th>Datum</th>
      <th class="col-actions"></th>
    </tr>
  </thead>

  <tbody>
    <tr *ngFor="let r of recs">
      <td>{{ r.recordType }}</td>
      <td>{{ r.originalFileName }}</td>
      <td>{{ r.createdAt | date:'short' }}</td>
      <td class="col-actions">
        <div class="row-actions">
          <button class="btn btn-download"
                  (click)="downloadScan(r.id, r.originalFileName)">Preuzmi</button>
          <button class="btn btn-ghost-danger"
        *ngIf="auth.role==='Admin'"
        (click)="deleteScan(r.id)">Obriši</button>
        </div>
      </td>
    </tr>
  </tbody>
</table>

    <p *ngIf="!recs.length" class="mt"><small class="muted">Nema dokumenata.</small></p>
  </div>
  <div *ngIf="tab==='id'" class="mt">
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div style="grid-column: 1 / -1">
        <div class="label">Naziv dokumenta</div> <input class="input" [(ngModel)]="docName" name="docName"
          placeholder="Lična karta, zdravstvena knjižica, pasoš…" />
      </div>
      <div>
        <div class="label">Datum izdavanja</div> <input class="input" type="date" [(ngModel)]="idIssue"
          name="idIssue" />
      </div>
      <div>
        <div class="label">Datum isteka</div> <input class="input" type="date" [(ngModel)]="idExpiry" name="idExpiry" />
      </div>
      <div style="grid-column:1/-1; display:flex; align-items:center; gap:.75rem;"><div class="file-wrap">
  <input #idInput id="idInput" type="file"
         (change)="onIdFile($event)"
         accept=".pdf,.png,.jpg,.jpeg"
         class="file-input" />
  <label for="idInput" class="file-label">Izaberi fajl</label>
  <span class="file-name">{{ idFile?.name || 'Nije izabran fajl' }}</span>
</div>

<button class="btn pri btn-compact"
        (click)="saveId(idInput)"
        [disabled]="!idFile || !docName?.trim()">Sačuvaj</button> </div>
    </div>
    <table class="table mt" *ngIf="iddocs.length">
      <thead>
        <tr>
          <th>Naziv</th>
          <th>Sken</th>
          <th>Datum unosa</th>
          <th class="col-actions"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let d of iddocs">
          <td>{{ d.docName }}</td>
          <td>{{ d.hasScan ? 'Yes' : 'No' }}</td>
          <td>{{ d.createdAt | date:'dd.MM.yyyy' }}</td>
          <td class="col-actions">
  <div class="row-actions">
    <button class="btn btn-download"
            (click)="downloadId(d.id)"
            [disabled]="!d.hasScan">Preuzmi</button>
    <button class="btn btn-ghost-danger"
            *ngIf="auth.role==='Admin'"
            (click)="deleteId(d.id)">Obriši</button>
  </div>
</td>
        </tr>
      </tbody>
    </table>
    <p *ngIf="!iddocs.length" class="mt"><small class="muted">Nema ličnih dokumenata.</small></p>
  </div> 
  <div *ngIf="tab==='ap'" class="mt">
    <div class="row"> <input class="input" type="datetime-local" [(ngModel)]="apStart" style="max-width:230px" /> <input
        class="input" [(ngModel)]="apReason" placeholder="Razlog (opciono)" /> <button class="btn ok"
        (click)="createAppt()">Zakaži pregled</button> </div>
    <table class="table mt" *ngIf="encs.length">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Status</th>
          <th>Razlog</th>
          <th class="col-actions"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let a of encs">
          <td>{{ a.encounterDate | date:'short' }}</td>
          <td> <span class="badge"
              [ngClass]="{ 'badge-s': a.status==='Scheduled', 'badge-c': a.status==='Completed', 'badge-x': a.status==='Canceled' }">
              {{ statusLabel(a.status) }} </span> </td>
          <td>{{ a.reason || '-' }}</td>
          <td class="col-actions">
            <div class="row-actions" *ngIf="a.status==='Scheduled'"> <button class="btn-blue-compact"
                (click)="startComplete(a.id)">Realizovano</button> <button class="btn-red-compact"
                (click)="cancelAppt(a.id)">Otkaži</button> </div>
          </td>
        </tr>
      </tbody>
    </table>
    <p *ngIf="!encs.length" class="mt"><small class="muted">Nema poseta.</small></p> 
    <div class="card" *ngIf="completeId">
      <div class="label">Napomena</div> <input class="input" [(ngModel)]="completeNotes"
        placeholder="Kratka napomena…" />
      <div class="inline-complete-actions"> <button class="btn ok" style="max-width: min-content;"
          (click)="saveComplete()">Sačuvaj</button> <button class="btn" (click)="completeId=undefined">Odustani</button>
      </div>
    </div>
  </div>